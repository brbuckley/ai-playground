name: Auto-Fix CI Failures

on:
  workflow_run:
    workflows: ["CI"]  # Must match the name in ci.yml
    types: [completed]
    branches:
      - main
      - 'claude/**'  # Claude's feature branches

jobs:
  fix-ci:
    # Only run if the CI workflow failed
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Push commits
      pull-requests: write # Create/update PRs
      issues: write        # Comment on issues
      actions: read        # Read CI results
      id-token: write      # Required for claude-code-action

    steps:
      - name: Checkout the failing branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0  # Full history for proper git operations

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run Claude to fix CI failures
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: |
            The CI pipeline failed on branch ${{ github.event.workflow_run.head_branch }}.

            Please fix all failures by following these steps:
            1. Navigate to the schreiber-batch-inventory directory
            2. Install dependencies: uv sync --extra dev
            3. Run all QA checks from CLAUDE.md in order:
               - uv run ruff format --check . (if fails, run: uv run ruff format .)
               - uv run ruff check . (fix any lint issues)
               - uv run ty check app/ (fix any type errors)
               - uv run pytest tests/unit (fix any test failures)
            4. After fixing each issue, verify the check passes
            5. Once all checks pass, commit with message: "fix: resolve CI failures"
            6. Push the commit to the current branch

            Work systematically through each failure. Do not skip any checks.

          additional_permissions: |
            actions: read

          # Allow QA tools and git operations
          claude_args: '--allowed-tools Bash(uv:*,ruff:*,ty:*,pytest:*,docker:*,git:*) --max-turns 25'

      - name: Comment on PR if exists
        if: always()
        run: |
          PR_NUMBER=$(gh pr list --head ${{ github.event.workflow_run.head_branch }} --json number --jq '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            if [ "${{ job.status }}" == "success" ]; then
              gh pr comment $PR_NUMBER --body "✅ Claude has attempted to fix the CI failures. Please review the changes."
            else
              gh pr comment $PR_NUMBER --body "❌ Claude attempted to fix CI failures but encountered issues. Manual intervention may be needed."
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}
